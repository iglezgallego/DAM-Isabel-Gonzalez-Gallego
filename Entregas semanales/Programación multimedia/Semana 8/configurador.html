<!doctype html>
<html>
    <head>
        <style>
            @font-face{
            font-family: coveltica;
            src: url(coveltica.otf);
            }
            body{
                background:#C8B8D4;
                font-family:coveltica;
                text-align:center;}
            #contenedor{
                width:512px;
                height:256px;
                margin:auto;}
            #contienelienzos{
                width:256px;
                height:256px;
                float:right;}
            #contieneparametros{
                width:256px;
                height:256px;
                float:left;
                text-align: right;
                }
            h2{
                margin:0px;
                padding:0px;
                font-size:18px;
                display:inline;}
            canvas{
                border:1px solid black;}
            /* los lienzos ocultos no se vean en la pantalla */
           #oculto{
                display:none;} 
        </style>
    </head>
    <body>
        <h1>Crea tu personaje</h1>
        
        <div id="contenedor">
            <!-- LIENZO PARA EL PERSONAJE -->
            <div id="contienelienzos">
                <!-- creo el lienzo para el persobaje de 256 x 256 -->
                <canvas width="256px" height="256px" id="lienzo"></canvas>
            </div>
            
            <!-- CONTENEDOR DE PARAMETROS -->
            <div id="contieneparametros">
                <h2>Color del pelo:</h2>
                <input type="color" id="colorpelo" class="color" value="#cccccc">
                <br><br>
                <h2>Color de la piel:</h2>
                <input type="color" id="colorpiel" class="color" value="#cccccc"><br><br>
                <h2>Color de la camiseta:</h2>
                <input type="color" id="colorcamiseta" class="color" value="#cccccc"><br><br>
                <h2>Color de los pantalones:</h2>
                <input type="color" id="colorpantalones" class="color" value="#cccccc"><br><br>
                <h2>Color de las zapatillas:</h2>
                <input type="color" id="colorzapatillas" class="color" value="#cccccc"><br><br>
            </div>
        </div>
        
        <!-- LIENZOS PARA CADA UNA DE LAS PARTES DEL PERSONAJE --> 
        <div id="oculto"> 
            <!-- 2048 es lo que ocupa el sprite entero -->
            <canvas id="imagenpelo" width=2048 height=2048></canvas>
            <canvas id="colorpelosolido" width=2048 height=2048></canvas>
            <canvas id="fusionpelo" width=2048 height=2048></canvas>
            
            <canvas id="imagenpiel" width=2048px height=2048px></canvas>
            <canvas id="colorpielsolido" width=2048px height=2048px></canvas>
            <canvas id="fusionpiel" width=2048px height=2048px></canvas>
           
            <canvas id="imagencamiseta" width=2048px height=2048px></canvas>
            <canvas id="colorcamisetasolido" width=2048px height=2048px></canvas>
            <canvas id="fusioncamiseta" width=2048px height=2048px></canvas>
           
            <canvas id="imagenpantalones" width=2048px height=2048px></canvas>
            <canvas id="colorpantalonessolido" width=2048px height=2048px></canvas>
            <canvas id="fusionpantalones" width=2048px height=2048px></canvas>
           
            <canvas id="imagenzapatilla" width=2048px height=2048px></canvas>
            <canvas id="colorzapatillasolido" width=2048px height=2048px></canvas>
            <canvas id="fusionzapatilla" width=2048px height=2048px></canvas>
             <!-- LIENZO PARA LA FUSION DE TODO --> 
            <canvas id="fusiondetodo" width=2048px height=2048px></canvas>
        </div>
        
        <!-- Carga JQuery --> 
        <script src="lib/code.jquery.com_jquery-3.7.1.min.js"></script>
        
        <script>
            //variable temporizador para gestionar el bucle
            var temporizador;
            //varibles X Y del sprite
            var spritex = 0;
            var spritey = 0;
            
            //CONTEXTOS PARA LOS LIENZOS
            //creo el contexto del lienzo
            var contexto = document.getElementById("lienzo").getContext("2d");
            //contexto pelo
            var ctxpeloimg = document.getElementById("imagenpelo").getContext("2d");
            var ctxpelocolor = document.getElementById("colorpelosolido").getContext("2d");
            var ctxpelofusion = document.getElementById("fusionpelo").getContext("2d");
            //Contexto Piel
            var ctxpielimg = document.getElementById("imagenpiel").getContext("2d");
            var ctxpielcolor = document.getElementById("colorpielsolido").getContext("2d");
            var ctxpielfusion = document.getElementById("fusionpiel").getContext("2d");
            //Contexto camiseta
            var ctxcamisetaimg = document.getElementById("imagencamiseta").getContext("2d");
            var ctxcamisetacolor = document.getElementById("colorcamisetasolido").getContext("2d");
            var ctxcamisetafusion = document.getElementById("fusioncamiseta").getContext("2d");
            //Contexto pantalones
            var ctxpantalonesimg = document.getElementById("imagenpantalones").getContext("2d");
            var ctxpantalonescolor = document.getElementById("colorpantalonessolido").getContext("2d");
            var ctxpantalonesfusion = document.getElementById("fusionpantalones").getContext("2d");
            //Contexto zapatillas
            var ctxzapatillasimg = document.getElementById("imagenzapatilla").getContext("2d");
            var ctxzapatillascolor = document.getElementById("colorzapatillasolido").getContext("2d");
            var ctxzapatillasfusion = document.getElementById("fusionzapatilla").getContext("2d");
            //Contexto de la fusion de todo
            var ctxfusiondetodo = document.getElementById("fusiondetodo").getContext("2d");
            
            
            //cargo la imagenes 
            var pelo = new Image(); pelo.src = "img/pelo.png";
            var pantalones = new Image(); pantalones.src = "img/pantalones.png";
            var camiseta = new Image(); camiseta.src = "img/camiseta.png";
            var piel = new Image(); piel.src = "img/piel.png";
            var cara = new Image(); cara.src = "img/cara.png";
            var pies = new Image(); pies.src = "img/pies.png";
            var sombra = new Image(); sombra.src = "img/sombra.png";
            var imagenfinal = new Image();
            
            //llamo a la funcion inicio
            inicio();
            
            //defino la función inicio que llama al bucle
            function inicio(){
                //ejecuto el bucle dentro de 1s
                temporizador = setTimeout("bucle()",1000);
                //cuando todo lo que tenga color cambie
                $(".color").change(function(){
                    
                    /////////////////// PELO ///////////////////////
                    ctxpeloimg.drawImage(pelo,0,0)
                    //pinta el color solido que seleccionamos en colorpelo
                    ctxpelocolor.fillStyle = $("#colorpelo").val();
                    //pinta el rectángulo del color seleccionado
                    ctxpelocolor.fillRect(0,0,2048,2048);
                    //coge los pixeles de la imagen pelo uno a uno
                    var pximgpelo = ctxpeloimg.getImageData(0,0,2048,2048)
                    //cojo los pixeles del color del rectangulo uno a uno
                    var pximgcolor = ctxpelocolor.getImageData(0,0,2048,2048)
                    //para todos los pixeles del pelo
                    for(var i = 0;i<pximgpelo.data.length;i++){
                        //los datos de los pixeles será igual a el mismo por los pixeles de color entre 255
                        pximgpelo.data[i] = (pximgpelo.data[i] * pximgcolor.data[i])/255
                    }
                    //introduzco los datos de los pixeles en pximgpelo en 0,0
                    ctxpelofusion.putImageData(pximgpelo,0,0)
                    
                    /////////////////// PIEL /////////////////
                    ctxpielimg.drawImage(piel,0,0)
                    ctxpielcolor.fillStyle = $("#colorpiel").val();
                    ctxpielcolor.fillRect(0,0,2048,2048);
                    var pximgpiel = ctxpielimg.getImageData(0,0,2048,2048)
                    var pximgcolor = ctxpielcolor.getImageData(0,0,2048,2048)
                    for(var i = 0;i<pximgpiel.data.length;i++){
                        pximgpiel.data[i] = (pximgpiel.data[i] * pximgcolor.data[i])/255
                    }
                    ctxpielfusion.putImageData(pximgpiel,0,0)
                    
                    /////////////////// CAMISETA /////////////////
                    ctxcamisetaimg.drawImage(camiseta,0,0)
                    ctxcamisetacolor.fillStyle = $("#colorcamiseta").val();
                    ctxcamisetacolor.fillRect(0,0,2048,2048);
                    var pximgcamiseta = ctxcamisetaimg.getImageData(0,0,2048,2048)
                    var pximgcolor = ctxcamisetacolor.getImageData(0,0,2048,2048)
                    for(var i = 0;i<pximgcamiseta.data.length;i++){
                        pximgcamiseta.data[i] = (pximgcamiseta.data[i] * pximgcolor.data[i])/255
                    }
                    ctxcamisetafusion.putImageData(pximgcamiseta,0,0)
                    
                    /////////////////// PANTALONES /////////////////
                    ctxpantalonesimg.drawImage(pantalones,0,0)
                    ctxpantalonescolor.fillStyle = $("#colorpantalones").val();
                    ctxpantalonescolor.fillRect(0,0,2048,2048);
                    var pximgpantalones = ctxpantalonesimg.getImageData(0,0,2048,2048)
                    var pximgcolor = ctxpantalonescolor.getImageData(0,0,2048,2048)
                    for(var i = 0;i<pximgpantalones.data.length;i++){
                        pximgpantalones.data[i] = (pximgpantalones.data[i] * pximgcolor.data[i])/255
                    }
                    ctxpantalonesfusion.putImageData(pximgpantalones,0,0)
                    
                    /////////////////// ZAPATATILLAS /////////////////
                    ctxzapatillasimg.drawImage(pies,0,0)
                    ctxzapatillascolor.fillStyle = $("#colorzapatillas").val();
                    ctxzapatillascolor.fillRect(0,0,2048,2048);
                    var pximgzapatilla = ctxzapatillasimg.getImageData(0,0,2048,2048)
                    var pximgcolor = ctxzapatillascolor.getImageData(0,0,2048,2048)
                    for(var i = 0;i<pximgzapatilla.data.length;i++){
                        pximgzapatilla.data[i] = (pximgzapatilla.data[i] * pximgcolor.data[i])/255
                    }
                   ctxzapatillasfusion.putImageData(pximgzapatilla,0,0)
                    
                    //FUSION DE TODO EN EL LIENZO DEL PERSONAJE
                    
                    var pixelespelo = ctxpelofusion.getImageData(0,0,2048,2048)
                    var pixelespiel = ctxpielfusion.getImageData(0,0,2048,2048)
                    var pixelescamiseta = ctxcamisetafusion.getImageData(0,0,2048,2048)
                    var pixelespantalones = ctxpantalonesfusion.getImageData(0,0,2048,2048)
                    var pixeleszapatillas = ctxzapatillasfusion.getImageData(0,0,2048,2048)
                    //para todos los pixeles
                    for(var i = 0;i<pixelespelo.data.length;i++){
                        //junta todos los pixeles de cada parte del personaje
                        pixelespelo.data[i] = pixelespelo.data[i]+pixelespiel.data[i]+pixelescamiseta.data[i]+pixelespantalones.data[i]+pixeleszapatillas.data[i]
                    }
                    ctxfusiondetodo.putImageData(pixelespelo,0,0)
                    //dibujamos la cara y la sombra del personaje
                    ctxfusiondetodo.drawImage(cara,0,0)
                    ctxfusiondetodo.drawImage(sombra,0,0)
                    //cargamos la imagen final en el lienzo fusiondetodo
                    imagenfinal.src = document.getElementById("fusiondetodo").toDataURL();
                })
            }
            
            //defino la funcion bucle
            function bucle(){
                //la posicion x horizontal se incrementa
                spritex++;
                //si la posicion x horizontal es mayor a 7, es decir el final del sprite horizontal
                if(spritex > 7){
                    //incremento la posicion y vertical
                    spritey++;
                    spritex = 0;
                }
                //cuando la posicion y vertical sea mayor a 7, es decir el final del sprite vertical
                if(spritey > 7){
                   spritey = 0;
                   }
                contexto.clearRect(0,0,256,256)
                
                //DIBUJAR LA IMAGEN FINAL
                //los primeros 4 numeros representan la región de la imagen que dibujamos y los ultimos 4 representan la region del lienzo donde se dibujan
                contexto.drawImage(imagenfinal,spritex*256,spritey*256,256,256,0,0,256,256);
                
                //borro el bucle anterior
                clearTimeout(temporizador)
                //creo un nuevo temporizador recursivo
                temporizador = setTimeout("bucle()",100)
            }
        </script>
    </body>
</html>