<!doctype html>
<html lang="es">
    <head>
        <title>Detección de movimiento</title>
        <style>
            html,body{background:black;}
            video{display:none;}
            canvas{position:absolute;top:0px;left:0px;}
            #lienzo2{opacity:0.5;}
        </style>
    </head>
    <body>
        <!-- creo un canvas con el lienzo -->
        <canvas id="lienzo" width="640px" height="480px"></canvas>
         <!-- creo un segundo canvas con otro lienzo -->
        <canvas id="lienzo2" width="640px" height="480px"></canvas>
        <!-- creo un video -->
        <video id="video" autoplay></video>
        <!-- creo un script -->
        <script>
            //Traigo los elementos y los guardo en constantes y variables iniciales
            const video = document.getElementById("video");
            const lienzo = document.getElementById("lienzo");
            const lienzo2 = document.getElementById("lienzo2");
            
            //Creo el contexto del lienzo
            const contexto = lienzo.getContext("2d");
            //Creo el contexto del lienzo2
            const contexto2 = lienzo2.getContext("2d");
            //Creo dos arrays para cuadrosx y cuadrosy
            var cuadrosx = []
            var cuadrosy = []
            
            var atencionx = []
            var atenciony = []
            
            //fondo semitransparente
            contexto2.fillStyle = "rgba(255,255,255,0.01)"
            
            //Cada cuantos pixeles voy a comparar tanto en horizontal como en vertical
            const paso = 16;
            //Creo contenedores para los valores de los pixeles nuevos y viejos para poder comparar el color y saber si se ha movido algo
            var pixelesviejos = [];
            var pixelesnuevos = [];
            //contador para comparar los pixeles nuevos y los viejos
            var contador = 0;
            //Sobre el objeto navigator capturo unicamente el video
            navigator.mediaDevices.getUserMedia({video:true})
                //En este caso 
                .then(function(flujo){
                    video.srcObject = flujo;
                
                })
                //En el caso de que falle
                .catch(function(error){
                    //muestar el error por pantalla
                    console.log("error: "+error)
                })
            
            //Pinto el video dentro del canvas
            function videoALienzo(){
                //Reinicio los cuadros
                cuadrosx = []
                cuadrosy = []
                //Creo una capa semitransparente
                contexto2.fillStyle = "rgba(255,255,255,0.01)"
                contexto2.fillRect(0,0,640,480)
                //En el canvas pego el video en 0,0, y pongo las dimensiones del lienzo
                contexto.drawImage(
                    video,
                    0,
                    0,
                    lienzo.width,
                    lienzo.height)
                //Para cada fotograma asigno a los pixeles nuevos los pixeles anteriores
                pixelesviejos = pixelesnuevos
                //Reinicio la información de los pixeles nuevos para ponerlos a continuación
                pixelesnuevos = [];
                
                //bucle for para recorrer las posiciones de la imagen horizontales
                for (let x = 0;x<640;x+=paso){
                    //for para recorrer las posiciones de la imagen verticales
                    for(let y = 0;y<480;y+=paso){
                        //Cojo el pixel en cada punto
                        let pixel = contexto.getImageData(x,y,1,1);
                        //Almaceno la información de color,x,y de los pixeles nuevos como un json
                        pixelesnuevos.push({
                            data:pixel.data,
                            x:x,
                            y:y
                        }) 
                    }
                }
                
                //ejecuta solo a partir de la segunda vuelta, no cuando contador es 0, ya que no hay pixeles viejos
                //si estoy en la segunda iteracción
                if (contador > 0){
                    //recorre todos los pixeles
                    for(let i = 0;i<pixelesnuevos.length;i++){
                        //repaso los pixeles nuevos y viejos en las variables haciendo una comparación 
                        
                        //de rojos
                        let rojonuevo = pixelesnuevos[i].data[0]
                        let rojoviejo = pixelesviejos[i].data[0]
                        //de verdes
                        let verdenuevo = pixelesnuevos[i].data[1]
                        let verdeviejo = pixelesviejos[i].data[1]
                        //de azules
                        let azulnuevo = pixelesnuevos[i].data[2]
                        let azulviejo = pixelesviejos[i].data[2]
                        
                        //dame la diferencia - siempre en valores positivos - entre los pixeles nuevos y viejos de cada color
                        let diferenciarojo = Math.abs(rojonuevo-rojoviejo)
                        let diferenciaverde = Math.abs(verdenuevo-verdeviejo)
                        let diferenciaazul = Math.abs(azulnuevo-azulviejo)
                        
                        //saco el promedio de la diferencia de cada color
                        let promedio = (diferenciarojo+diferenciaverde+diferenciaazul)/3
                        
                        //si la diferencia es grande, es que hay movimiento
                        if(promedio > 20){
                            //si detecta movimiento, dibuja un cuadro alrededor
                            contexto2.strokeRect(
                                pixelesnuevos[i].x,
                                pixelesnuevos[i].y,
                                paso,
                                paso)
                            
                            
                            if(typeof(cuadrosx[pixelesnuevos[i].x]) == 'undefined'){
                                cuadrosx[pixelesnuevos[i].x] = 1
                            }else{
                                cuadrosx[pixelesnuevos[i].x]++
                            }
                            
                            if(typeof(cuadrosy[pixelesnuevos[i].y]) == 'undefined'){
                                cuadrosy[pixelesnuevos[i].y] = 1
                            }else{
                                cuadrosy[pixelesnuevos[i].y]++
                            }
                        }
                    }
                }
                
                //PARA EL CALCULO DE MAX Y MIN
                let maxx = 0;
                let maxcuentax = 0;
                let maxy = 0;
                let maxcuentay = 0;
                
                //Busqueda de máximos en X
                cuadrosx.forEach(function(number, index){
                    if(number > maxcuentax){
                        maxcuentax = number;
                        maxx = index
                    }
                });
                
                //Búsqueda de maximos en Y
                cuadrosy.forEach(function(number, index){
                    if(number > maxcuentay){
                        maxcuentay = number;
                        maxy = index
                    }
                });
                
                //Para que no de un falso positivo en cero
                if(maxx != 0){
                    //Creo el punto de atención
                    atencionx.push(maxx)
                    atenciony.push(maxy)
                    
                    if(atencionx.length > 10){
                        atencionx.splice(0,1)
                        atenciony.splice(0,1)
                    }
                    let sumax = 0;
                    let sumay = 0;
                    for(let i=0; i<10; i++){
                        sumax += atencionx[i]
                        sumay += atenciony[i]
                    }
                    sumax /= 10
                    sumay /= 10
                    
                    
                    //Dibuja una linea en vertical
                    contexto2.beginPath();
                    contexto2.moveTo(maxx,0)
                    contexto2.lineTo(maxx,480)
                    contexto2.stroke();

                    //Dibuja una linea en horizontal
                    contexto2.beginPath();
                    contexto2.moveTo(0,maxy);
                    contexto2.lineTo(640,maxy);
                    contexto2.stroke();

                    //Dibujo un circulo
                    contexto2.beginPath()
                    contexto2.arc(maxx,maxy,30,0,Math.PI*2,true)
                    contexto2.stroke()
                    
                    //Dibujo un punto rojo de atención
                    contexto2.fillStyle = "red"
                    contexto2.beginPath()
                    contexto2.arc(sumax,sumay,10,0,Math.PI*2,true)
                    contexto2.fill()
                }
                
                //Aumento el contador
                contador++;
                //funcion recursiva que se llama a si misma
                requestAnimationFrame(videoALienzo)
            }
            //Cuando al vídeo le de al play 
            video.addEventListener('play',function(){
                //ejecuto la función 
                videoALienzo()
            })
        </script>
    </body>

</html>